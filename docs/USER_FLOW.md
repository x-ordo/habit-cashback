# 유저플로우 정의서 (User Flow Definition)

> **습관환급 (Habit Cashback) 사용자 흐름 가이드**
> 버전: 1.0 | 최종 수정: 2025-12-22

---

## 1. 전체 플로우 개요

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           습관환급 (Habit Cashback)                          │
│                              전체 유저플로우                                  │
└─────────────────────────────────────────────────────────────────────────────┘

                              [앱 진입]
                                  │
                                  ▼
                        ┌─────────────────┐
                        │   /login        │
                        │   로그인 화면    │
                        └────────┬────────┘
                                 │
                   ┌─────────────┴─────────────┐
                   │                           │
            [토스앱 환경]               [브라우저 환경]
            appLogin() SDK              스텁 로그인
                   │                           │
                   └─────────────┬─────────────┘
                                 │
                                 ▼
                        ┌─────────────────┐
                        │   / (홈)        │
                        │  챌린지 목록    │◄────────────────┐
                        └────────┬────────┘                │
                                 │                         │
              ┌──────────────────┼──────────────────┐      │
              │                  │                  │      │
              ▼                  ▼                  ▼      │
     ┌────────────┐    ┌────────────┐    ┌────────────┐   │
     │ 챌린지 #1  │    │ 챌린지 #2  │    │ 챌린지 #3  │   │
     │ 7000보    │    │ 이불개기   │    │ 도시락    │   │
     └─────┬──────┘    └─────┬──────┘    └─────┬──────┘   │
           │                 │                 │          │
           └────────────────┬┴─────────────────┘          │
                            │                             │
                            ▼                             │
                   ┌─────────────────┐                    │
                   │ /challenge/:id  │                    │
                   │  챌린지 상세    │                    │
                   │  정산 계약서    │                    │
                   └────────┬────────┘                    │
                            │                             │
                    [보증금 맡기기]                        │
                            │                             │
                            ▼                             │
                   ┌─────────────────┐                    │
                   │  /proof/:id    │                    │
                   │  인증 제출     │                    │
                   └────────┬────────┘                    │
                            │                             │
                    [인증 제출]                           │
                            │                             │
                            ▼                             │
                   ┌─────────────────┐                    │
                   │  /history      │                    │
                   │  정산 내역     │────────────────────┘
                   └─────────────────┘


                    [보조 화면]
              ┌──────────┬──────────┬──────────┐
              │          │          │          │
              ▼          ▼          ▼          ▼
        ┌─────────┐┌─────────┐┌─────────┐┌─────────┐
        │ /help   ││ /terms  ││/privacy ││/support │
        │이용안내 ││이용약관 ││개인정보 ││고객센터 │
        └─────────┘└─────────┘└─────────┘└─────────┘
```

---

## 2. 화면별 상세 플로우

### 2.1 로그인 (`/login`)

```
┌─────────────────────────────────────────────────────────────┐
│                        로그인 화면                           │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│                      [습관환급 로고]                         │
│                                                              │
│                 ┌────────────────────────┐                  │
│                 │    토스로 시작하기     │ ◄── Primary CTA  │
│                 └────────────────────────┘                  │
│                                                              │
│                    이용약관 | 개인정보                       │
│                                                              │
└─────────────────────────────────────────────────────────────┘
```

| 항목 | 내용 |
|------|------|
| **진입 조건** | 앱 최초 진입 또는 세션 만료 |
| **URL 파라미터** | `?reason=unlinked` - 토스 연결 해제 시 |
| **사용자 액션** | "토스로 시작하기" 버튼 탭 |
| **시스템 처리** | 아래 참조 |
| **성공 시** | `/` (홈)으로 이동 |
| **실패 시** | 에러 메시지 표시, 재시도 가능 |

**로그인 처리 흐름:**
```
1. 토스앱 환경 감지
   │
   ├─ [토스앱 WebView]
   │   └─ appLogin() SDK 호출
   │       └─ authorizationCode 획득
   │           └─ POST /v1/auth/toss/exchange
   │               └─ sessionToken 발급
   │
   └─ [일반 브라우저]
       └─ POST /v1/auth/exchange
           └─ stub 토큰 발급 (개발용)
```

---

### 2.2 홈 - 챌린지 목록 (`/`)

```
┌─────────────────────────────────────────────────────────────┐
│  ←  습관환급                                    이용안내 →  │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│  공식 챌린지                                                 │
│                                                              │
│  ┌─────────────────────────────────────────────────────┐    │
│  │  🚶 매일 7,000보 걷기                               │    │
│  │  3일 | 보증금 10,000원                      →      │    │
│  └─────────────────────────────────────────────────────┘    │
│                                                              │
│  ┌─────────────────────────────────────────────────────┐    │
│  │  🛏️ 아침 7시 이불 개기                              │    │
│  │  3일 | 보증금 10,000원                      →      │    │
│  └─────────────────────────────────────────────────────┘    │
│                                                              │
│  ┌─────────────────────────────────────────────────────┐    │
│  │  🥗 점심 도시락/샐러드 인증                         │    │
│  │  3일 | 보증금 10,000원                      →      │    │
│  └─────────────────────────────────────────────────────┘    │
│                                                              │
│                    내 정산내역 보기 →                        │
│                                                              │
├─────────────────────────────────────────────────────────────┤
│  이용약관 | 개인정보처리방침 | 고객센터 | 이용안내          │
└─────────────────────────────────────────────────────────────┘
```

| 항목 | 내용 |
|------|------|
| **진입 조건** | 로그인 완료 (RequireAuth) |
| **데이터 로드** | `GET /v1/challenges` |
| **표시 항목** | 챌린지 제목, 기간, 보증금 |
| **사용자 액션** | 챌린지 카드 탭 → `/challenge/:id` |
| **보조 액션** | "정산내역 보기" → `/history` |

**공식 챌린지 목록:**
| ID | 제목 | 기간 | 보증금 | 인증 방식 |
|----|------|------|--------|-----------|
| walk-7000 | 매일 7,000보 걷기 | 3일 | 10,000원 | steps |
| bed-0700 | 아침 7시 이불 개기 | 3일 | 10,000원 | photo |
| lunch-proof | 점심 도시락/샐러드 인증 | 3일 | 10,000원 | photo |

---

### 2.3 챌린지 상세 (`/challenge/:id`)

```
┌─────────────────────────────────────────────────────────────┐
│  ←  정산 계약                                               │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│  ┌─────────────────────────────────────────────────────┐    │
│  │              📜 정산 계약서                          │    │
│  │  ─────────────────────────────────────────────────  │    │
│  │                                                      │    │
│  │  품목      매일 7,000보 걷기                         │    │
│  │  기간      3일 (작심삼일)                            │    │
│  │  참가비    10,000원                                  │    │
│  │                                                      │    │
│  │  ─────────────────────────────────────────────────  │    │
│  │                                                      │    │
│  │  성공 시   10,000원 환급                             │    │
│  │  실패 시   리워드 미지급                             │    │
│  │                                                      │    │
│  └─────────────────────────────────────────────────────┘    │
│                                                              │
│  ※ 매일 인증을 완료해야 성공으로 인정됩니다.                │
│  ※ 인증 마감은 매일 자정입니다.                             │
│                                                              │
├─────────────────────────────────────────────────────────────┤
│  ┌─────────────────────────────────────────────────────┐    │
│  │           10,000원 보증금 맡기기                    │ ◄─ │
│  └─────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────┘
```

| 항목 | 내용 |
|------|------|
| **URL 파라미터** | `:id` - 챌린지 ID |
| **표시 내용** | 정산 계약서 (제목, 기간, 금액, 조건) |
| **사용자 액션** | "보증금 맡기기" 버튼 탭 |
| **시스템 처리** | 아래 참조 |
| **성공 시** | `/proof/:id` 로 이동 |

**결제 처리 흐름:**
```
[보증금 맡기기 탭]
        │
        ▼
POST /v1/payments/create
  ├─ Header: Idempotency-Key (UUID)
  ├─ Body: { challengeId, amount }
  └─ Response: { paymentId }
        │
        ▼
POST /v1/payments/execute
  ├─ Body: { paymentId }
  └─ Response: { ok: true, status: "done" }
        │
        ▼
Navigate to /proof/:id
```

---

### 2.4 인증 제출 (`/proof/:id`)

```
┌─────────────────────────────────────────────────────────────┐
│  ←  오늘 인증                                  정산내역 →   │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│  매일 7,000보 걷기                                          │
│                                                              │
│  ┌─────────────────────────────────────────────────────┐    │
│  │                                                      │    │
│  │                                                      │    │
│  │              [사진 선택 영역]                        │    │
│  │                                                      │    │
│  │         📷 카메라로 촬영하거나                       │    │
│  │            갤러리에서 선택하세요                     │    │
│  │                                                      │    │
│  │                                                      │    │
│  └─────────────────────────────────────────────────────┘    │
│                                                              │
│  ※ 오늘 촬영한 사진만 인정됩니다.                           │
│  ※ EXIF 정보로 촬영 시간을 확인합니다.                      │
│                                                              │
├─────────────────────────────────────────────────────────────┤
│  ┌─────────────────────────────────────────────────────┐    │
│  │                  인증 제출                          │ ◄─ │
│  └─────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────┘
```

| 항목 | 내용 |
|------|------|
| **URL 파라미터** | `:id` - 챌린지 ID |
| **인증 방식** | `photo`: 사진 선택, `steps`: 자동 승인 |
| **사용자 액션** | 파일 선택 → "인증 제출" 탭 |
| **시스템 처리** | 아래 참조 |
| **성공 시** | `/history` 로 이동 |

**인증 제출 흐름:**
```
[photo 인증]                    [steps 인증]
     │                               │
     ▼                               ▼
파일 선택                       자동 처리
     │                               │
     ▼                               │
Base64 인코딩                        │
     │                               │
     └───────────┬───────────────────┘
                 │
                 ▼
     POST /v1/proofs/submit
       ├─ Header: Idempotency-Key
       ├─ Body (photo): { challengeId, imageBase64 }
       └─ Body (steps): { challengeId, imageHash: "steps-demo" }
                 │
                 ▼
     Response: { ok: true, status: "accepted" }
                 │
                 ▼
     Navigate to /history (500ms 후)
```

---

### 2.5 정산 내역 (`/history`)

```
┌─────────────────────────────────────────────────────────────┐
│  ←  정산내역                                                │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│  ┌─────────────────────────────────────────────────────┐    │
│  │  🚶 매일 7,000보 걷기                               │    │
│  │  상태: 진행중 (2/3일 완료)              ⏳          │    │
│  └─────────────────────────────────────────────────────┘    │
│                                                              │
│  ┌─────────────────────────────────────────────────────┐    │
│  │  🛏️ 아침 7시 이불 개기                              │    │
│  │  상태: 성공! 환급 예정                  ✅          │    │
│  └─────────────────────────────────────────────────────┘    │
│                                                              │
│  ┌─────────────────────────────────────────────────────┐    │
│  │  🥗 점심 도시락/샐러드 인증                         │    │
│  │  상태: 실패 (1일차 미인증)              ❌          │    │
│  └─────────────────────────────────────────────────────┘    │
│                                                              │
├─────────────────────────────────────────────────────────────┤
│  이용약관 | 개인정보처리방침 | 고객센터 | 이용안내          │
└─────────────────────────────────────────────────────────────┘
```

| 항목 | 내용 |
|------|------|
| **데이터 로드** | `GET /v1/settlements` |
| **표시 내용** | 챌린지별 상태, 환급 가능 여부 |
| **상태 값** | `running`, `success`, `failed` |
| **사용자 액션** | 홈으로 돌아가기 (← 버튼) |

**정산 상태:**
| 상태 | 표시 | 설명 |
|------|------|------|
| running | ⏳ 진행중 | 챌린지 진행 중 |
| success | ✅ 성공 | 모든 인증 완료, 환급 예정 |
| failed | ❌ 실패 | 인증 미완료, 리워드 미지급 |

---

## 3. 보조 화면

### 3.1 이용안내 (`/help`)

| 항목 | 내용 |
|------|------|
| **접근 경로** | 홈 → "이용안내" 링크 |
| **내용** | 서비스 이용 방법 안내 |

### 3.2 이용약관 (`/terms`)

| 항목 | 내용 |
|------|------|
| **접근 경로** | 모든 화면 하단 LegalFooter |
| **내용** | 서비스 이용약관 전문 |

### 3.3 개인정보처리방침 (`/privacy`)

| 항목 | 내용 |
|------|------|
| **접근 경로** | 모든 화면 하단 LegalFooter |
| **내용** | 개인정보 처리방침 전문 |

### 3.4 고객센터 (`/support`)

| 항목 | 내용 |
|------|------|
| **접근 경로** | 모든 화면 하단 LegalFooter |
| **내용** | 문의 이메일, FAQ |

---

## 4. 인증 및 세션 관리

### 4.1 토큰 수명주기

```
[로그인]                    [사용 중]                   [만료/해제]
    │                           │                           │
    ▼                           ▼                           ▼
토큰 발급              API 요청마다 토큰 첨부          토큰 삭제
    │                           │                           │
    ▼                           ▼                           ▼
localStorage 저장       Authorization: Bearer       /login?reason=unlinked
    │                           │                           │
    ▼                           │                           │
유효기간: 24시간               │                           │
                               │                           │
                    ┌──────────┴──────────┐                │
                    │                     │                │
              [정상 응답]           [401 Unauthorized]      │
                    │                     │                │
                    ▼                     └─────────────────┘
               계속 사용
```

### 4.2 세션 취소 (Unlink)

```
[토스앱에서 연결 끊기]
         │
         ▼
POST /v1/auth/toss/unlink-callback
  └─ { userKey, referrer }
         │
         ▼
서버: revoked store에 추가
         │
         ▼
다음 API 요청 시 401 응답
         │
         ▼
프론트엔드: clearAccessToken()
         │
         ▼
/login?reason=unlinked 리다이렉트
```

---

## 5. 에러 처리 플로우

### 5.1 API 에러

| HTTP 코드 | 상황 | 처리 |
|-----------|------|------|
| 401 | 토큰 만료/취소 | 자동 로그아웃 → 로그인 페이지 |
| 409 | 중복 요청 | 에러 메시지 표시 |
| 429 | 속도 제한 | 잠시 후 재시도 안내 |
| 5xx | 서버 오류 | 에러 메시지 표시 |

### 5.2 네트워크 에러

```
[API 호출 실패]
      │
      ▼
폴백 데이터 사용 (가능한 경우)
      │
      ├─ 홈: OFFICIAL_CHALLENGES 표시
      └─ 기타: 에러 메시지 표시
```

---

## 6. 멱등성 보장

### 6.1 멱등성 키 사용 API

| API | 멱등성 키 | 목적 |
|-----|-----------|------|
| POST /v1/payments/create | 필수 | 중복 결제 방지 |
| POST /v1/proofs/submit | 필수 | 중복 인증 방지 |

### 6.2 처리 방식

```
[첫 번째 요청]          [중복 요청]
      │                      │
      ▼                      ▼
Idempotency-Key         동일한 Key
      │                      │
      ▼                      ▼
처리 및 저장 (2분 TTL)    409 Conflict
      │                      │
      ▼                      ▼
정상 응답                 에러 메시지
```

---

## 7. 업그레이드 로드맵

### Phase 1: 핵심 기능 (현재)
- [x] 전체 화면 구현
- [x] 인증 체계 (JWT + mTLS)
- [ ] API-DB 연동
- [ ] 정산 내역 API

### Phase 2: 검증 강화
- [ ] EXIF 시간 검증
- [ ] 이미지 중복 해시 검증
- [ ] Vision AI 분류 (선택)

### Phase 3: 자동화
- [ ] 챌린지 종료 배치
- [ ] 정산 상태 갱신 배치
- [ ] 토스페이 SDK 연동

---

## 변경 이력

| 버전 | 날짜 | 변경 내용 |
|------|------|-----------|
| 1.0 | 2025-12-22 | 최초 작성 |
