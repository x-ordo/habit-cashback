# 화면 정의서 (Screen Definition)

> **앱인토스(Apps in Toss) 가이드라인 반영 버전**
> 참고: https://developers-apps-in-toss.toss.im/

## 개요

| 항목 | 내용 |
|------|------|
| **서비스명** | 습관환급 (Habit Cashback) |
| **플랫폼** | 토스 앱인토스 WebView (Granite) |
| **기술스택** | React 18 + TypeScript + Vite |
| **UI 라이브러리** | @toss-design-system/mobile 2.1.0 |
| **SDK** | @apps-in-toss/web-framework 1.1.1 |

---

## 앱인토스 설정 (granite.config.ts)

```typescript
{
  appName: "habitcashback",        // 콘솔 App ID와 동일
  brand: {
    displayName: "습관환급",
    primaryColor: "#3182F6",
    bridgeColorMode: "basic"
  },
  permissions: [
    { name: "camera", access: "access" },  // 사진 인증용
    { name: "photos", access: "read" }     // 갤러리 접근용
  ],
  webViewProps: {
    type: "partner",                 // 일반 파트너 서비스
    bounces: false,
    pullToRefreshEnabled: false,
    overScrollMode: "never"
  }
}
```

---

## 앱인토스 심사 가이드라인 준수 사항

### 필수 준수
| 항목 | 상태 | 설명 |
|------|------|------|
| iframe 금지 | O | 유튜브 외 iframe 미사용 |
| mTLS 인증 | O | 백엔드 API 호출 시 필수 |
| 토큰 기반 인증 | O | iOS 쿠키 제약 대응 |
| 최소 권한 요청 | O | camera, photos만 요청 |
| 개인정보처리방침 | O | /privacy 페이지 제공 |
| 이용약관 | O | /terms 페이지 제공 |

### 사행성 회피 용어 가이드
| 사용 용어 | 회피 용어 |
|----------|----------|
| 참가비 | ~~배팅금~~ |
| 리워드/환급 | ~~수익/투자금~~ |
| 성공 조건 | ~~배당률~~ |
| 미지급 | ~~손실~~ |
| 습관 형성 | ~~재테크~~ |

---

## 화면 목록

| # | 화면명 | 경로 | 인증 | 앱인토스 API |
|---|--------|------|------|-------------|
| 1 | 로그인 | `/login` | X | appLogin() |
| 2 | 홈(챌린지 목록) | `/` | O | - |
| 3 | 챌린지 상세 | `/challenge/:id` | O | - |
| 4 | 인증 제출 | `/proof/:id` | O | camera 권한 |
| 5 | 정산 내역 | `/history` | O | - |
| 6 | 이용안내 | `/help` | X | - |
| 7 | 고객센터 | `/support` | X | - |
| 8 | 이용약관 | `/terms` | X | - |
| 9 | 개인정보처리방침 | `/privacy` | X | - |

---

## 1. 로그인 페이지 (`/login`)

**파일**: `frontend/src/pages/LoginPage.tsx`

### 앱인토스 연동

```typescript
import { appLogin } from "@apps-in-toss/web-framework";

// 토스 로그인 SDK 호출
const { authorizationCode, referrer } = await appLogin();

// 서버에서 토큰 교환 (mTLS 필수)
const resp = await apiPost("/v1/auth/toss/exchange", {
  authorizationCode,
  referrer,
});
```

### 화면 구성

```
┌─────────────────────────────────────┐
│                                     │
│  로그인                             │
│                                     │
│  [토스 연결 해제 시 메시지]         │
│                                     │
│  토스앱에서는 토스 로그인을 통해    │
│  인가 코드를 받고, 서버에서 토큰    │
│  으로 교환합니다.                   │
│                                     │
│  [에러 메시지 영역]                 │
│                                     │
│  ┌─────────────────────────────┐    │
│  │       토스 로그인            │    │
│  └─────────────────────────────┘    │
│                                     │
│  * 인가 코드 유효시간: 10분         │
│  * 로컬에서는 데모 로그인 대체      │
│                                     │
│  ─────────────────────────────────  │
│  이용약관 | 개인정보처리방침 | ...  │
└─────────────────────────────────────┘
```

### 요소 상세

| 요소 | 타입 | TDS 컴포넌트 | 설명 |
|------|------|--------------|------|
| 타이틀 | Text | t2, bold | "로그인" |
| 연결해제 안내 | Text | t6, red500 | reason=unlinked 시 표시 |
| 설명 | Text | t6, grey600 | 로그인 방식 안내 |
| 에러 메시지 | Text | t6, red500 | 로그인 실패 시 |
| 로그인 버튼 | Button | size="large" | 토스 로그인 실행 |
| 안내문 | Text | t7, grey600 | 인가 코드 유효시간 등 |
| LegalFooter | 컴포넌트 | - | 약관/고객센터 링크 |

### 동작 흐름

```
[토스 로그인 버튼 클릭]
        │
        ▼
┌───────────────────────┐
│ appLogin() SDK 호출   │ ← 앱인토스 Web SDK
└───────────┬───────────┘
            │ authorizationCode, referrer
            ▼
┌───────────────────────┐
│ POST /v1/auth/toss/   │ ← 백엔드 (mTLS 필수)
│      exchange         │
└───────────┬───────────┘
            │ sessionToken
            ▼
┌───────────────────────┐
│ 토큰 저장 → 홈 이동   │
└───────────────────────┘

[폴백: 비토스 환경]
        │
        ▼
┌───────────────────────┐
│ POST /v1/auth/exchange│ ← 스텁 로그인 (개발용)
└───────────────────────┘
```

---

## 2. 홈 - 챌린지 목록 (`/`)

**파일**: `frontend/src/pages/HomePage.tsx`

### 화면 구성

```
┌─────────────────────────────────────┐
│ ← │ 습관환급            │ 이용안내 │  TopBar
├─────────────────────────────────────┤
│                                     │
│  공식 챌린지 3개만 제공합니다.      │
│  (심사/초기 운영 최적화)            │
│                                     │
│  [백엔드 연결 실패 시 에러 표시]    │
│                                     │
├─────────────────────────────────────┤
│  매일 7,000보 걷기              →   │  ListRow
│  3일 · 참가비 10,000원              │
├─────────────────────────────────────┤
│  아침 7시 이불 개기              →  │  ListRow
│  3일 · 참가비 10,000원              │
├─────────────────────────────────────┤
│  점심 도시락/샐러드 인증         →  │  ListRow
│  3일 · 참가비 10,000원              │
├─────────────────────────────────────┤
│                                     │
│  내 정산내역 보기 →                 │
│                                     │
│  ─────────────────────────────────  │
│  이용약관 | 개인정보처리방침 | ...  │
└─────────────────────────────────────┘
```

### TDS 컴포넌트 사용

```typescript
import { List, ListRow, Text } from "@toss-design-system/mobile";

<List>
  {items.map((c) => (
    <ListRow
      key={c.id}
      contents={
        <ListRow.Texts
          type="2RowTypeA"
          top={c.title}
          bottom={`${c.days}일 · 참가비 ${formatKRW(c.deposit)}`}
        />
      }
      withArrow={true}
      onClick={() => nav(`/challenge/${c.id}`)}
    />
  ))}
</List>
```

### 데이터

**공식 챌린지** (OFFICIAL_CHALLENGES):

| ID | 제목 | 기간 | 참가비 | 인증방식 | 설명 |
|----|------|------|--------|----------|------|
| walk-7000 | 매일 7,000보 걷기 | 3일 | 10,000원 | steps | 만보기 연동 |
| bed-0700 | 아침 7시 이불 개기 | 3일 | 10,000원 | photo | 사진 인증 |
| lunch-proof | 점심 도시락/샐러드 인증 | 3일 | 10,000원 | photo | 사진 인증 |

---

## 3. 챌린지 상세 (`/challenge/:id`)

**파일**: `frontend/src/pages/ChallengeDetailPage.tsx`

### 화면 구성

```
┌─────────────────────────────────────┐
│ ← │ 정산 계약                       │  TopBar
├─────────────────────────────────────┤
│                                     │
│  ┌─────────────────────────────┐    │
│  │ 정산 계약서                  │    │
│  │                             │    │  ReceiptCard
│  │ 품목     아침 7시 이불 개기 │    │
│  │ 기간     3일 (작심삼일)     │    │
│  │ 참가비   10,000원           │    │
│  │ ─────────────────────────── │    │
│  │ 성공 시  10,000원 환급      │    │
│  │ 실패 시  리워드 미지급      │    │
│  │                             │    │
│  │ * 정산/리워드 지급 기준은   │    │
│  │   이용안내·약관을 따릅니다. │    │
│  └─────────────────────────────┘    │
│                                     │
│  ─────────────────────────────────  │
│  이용약관 | 개인정보처리방침 | ...  │
│                                     │
├─────────────────────────────────────┤
│  ┌─────────────────────────────┐    │
│  │  10,000원 보증금 맡기기      │    │  BottomCTA
│  └─────────────────────────────┘    │
└─────────────────────────────────────┘
```

### 결제 흐름 (향후 토스페이 연동)

```
[보증금 맡기기 클릭]
        │
        ▼
┌───────────────────────┐
│ POST /v1/payments/    │
│      create           │
│ (challengeId, amount) │
└───────────┬───────────┘
            │ paymentId
            ▼
┌───────────────────────┐
│ (토스페이 SDK 호출)   │ ← 향후 연동
│ makePayment()         │
└───────────┬───────────┘
            │
            ▼
┌───────────────────────┐
│ POST /v1/payments/    │
│      execute          │
└───────────┬───────────┘
            │
            ▼
┌───────────────────────┐
│ /proof/:id 로 이동    │
└───────────────────────┘
```

---

## 4. 인증 제출 (`/proof/:id`)

**파일**: `frontend/src/pages/ProofPage.tsx`

### 앱인토스 권한 사용

```typescript
// granite.config.ts에서 설정된 권한
permissions: [
  { name: "camera", access: "access" },  // 카메라 직접 촬영
  { name: "photos", access: "read" }     // 갤러리 이미지 선택
]
```

### 화면 구성

```
┌─────────────────────────────────────┐
│ ← │ 오늘 인증                       │  TopBar
├─────────────────────────────────────┤
│                                     │
│  [챌린지 제목]                      │
│  사진 인증(카메라 권장).            │
│  EXIF/중복검증은 서버에서 처리.     │
│                                     │
│  ┌─────────────────────────────┐    │
│  │ [파일 선택] 사진선택         │    │
│  │  capture="environment"      │    │  <input type="file">
│  │  accept="image/*"           │    │
│  │                             │    │
│  │ 선택됨: photo.jpg           │    │
│  └─────────────────────────────┘    │
│                                     │
│  [인증 결과 메시지]                 │
│                                     │
│  ┌─────────────────────────────┐    │
│  │     정산내역 보기            │    │
│  └─────────────────────────────┘    │
│                                     │
│  ─────────────────────────────────  │
│  이용약관 | 개인정보처리방침 | ...  │
│                                     │
├─────────────────────────────────────┤
│  ┌─────────────────────────────┐    │
│  │       인증 제출              │    │  BottomCTA
│  └─────────────────────────────┘    │
└─────────────────────────────────────┘
```

### 인증 타입별 UI

| proofType | UI 요소 | 권한 |
|-----------|---------|------|
| photo | `<input type="file" accept="image/*" capture="environment">` | camera, photos |
| steps | 텍스트 안내 (서버 자동 승인) | - |

### 인증 제출 흐름

```
[사진 선택/촬영]
        │
        ▼
┌───────────────────────┐
│ File → Base64 변환    │
└───────────┬───────────┘
            │
            ▼
┌───────────────────────┐
│ POST /v1/proofs/      │
│      submit           │
│ (challengeId,         │
│  imageBase64)         │
└───────────┬───────────┘
            │
            ▼
┌───────────────────────┐
│ 서버 검증             │
│ - EXIF 시간 확인      │
│ - 중복 이미지 차단    │
│ - (향후) Vision AI    │
└───────────┬───────────┘
            │
            ▼
┌───────────────────────┐
│ /history 로 이동      │
└───────────────────────┘
```

---

## 5. 정산 내역 (`/history`)

**파일**: `frontend/src/pages/HistoryPage.tsx`

### 화면 구성

```
┌─────────────────────────────────────┐
│ ← │ 정산내역                        │  TopBar
├─────────────────────────────────────┤
│                                     │
│  [에러 메시지 영역]                 │
│                                     │
├─────────────────────────────────────┤
│  walk-7000                          │  ListRow
│  running · refundable=N             │
├─────────────────────────────────────┤
│  bed-0700                           │  ListRow
│  success · refundable=Y             │
├─────────────────────────────────────┤
│  lunch-proof                        │  ListRow
│  failed · refundable=N              │
├─────────────────────────────────────┤
│                                     │
│  ─────────────────────────────────  │
│  이용약관 | 개인정보처리방침 | ...  │
└─────────────────────────────────────┘
```

### 정산 상태

| status | 설명 | refundable |
|--------|------|------------|
| running | 챌린지 진행 중 | N |
| success | 성공 (리워드 지급) | Y |
| failed | 실패 (미지급) | N |

---

## 6~9. 정적 페이지

### 6. 이용안내 (`/help`)

| 섹션 | 내용 |
|------|------|
| 서비스 개요 | 습관 형성 서비스, 비사행성 명시 |
| 이용 흐름 | 챌린지 선택 → 결제 → 인증 → 결과 |
| 이용 제한 | 앱인토스 정책 (연령, 워크스페이스) |
| 부정 사용 방지 | EXIF 검증, 중복 차단, Vision AI |

### 7. 고객센터 (`/support`)

| 항목 | 환경변수 | 기본값 |
|------|----------|--------|
| 이메일 | VITE_SUPPORT_EMAIL | support@habitrefund.example |
| 운영시간 | VITE_SUPPORT_HOURS | 평일 10:00~18:00 (KST) |

### 8. 이용약관 (`/terms`)

| 조항 | 핵심 내용 |
|------|----------|
| 제1조 | 서비스 성격 - 습관 형성, 비사행성/비투자 |
| 제2조 | 참가비/리워드 정의 |
| 제3조 | 인증 조건, 부정행위 제재 |
| 제4조 | 문의/분쟁 조정 |

### 9. 개인정보처리방침 (`/privacy`)

| 항목 | 내용 |
|------|------|
| 시행일 | VITE_PRIVACY_EFFECTIVE_DATE |
| 수집 항목 | 토큰 식별자, 접속 로그, 인증 사진 (최소화) |
| 이용 목적 | 로그인, 인증, 결과 안내, 부정 방지, CS |
| 보관/삭제 | 법령 기준, 열람/정정/삭제 요청 가능 |

---

## 공통 컴포넌트

### TopBar

**파일**: `frontend/src/components/TopBar.tsx`

```
┌─────────────────────────────────────┐
│ [←]  │  [title]         │  [right] │
└─────────────────────────────────────┘
```

| Props | 타입 | 설명 |
|-------|------|------|
| title | string | 페이지 타이틀 |
| right | ReactNode | 우측 영역 (선택) |
| backTo | string | 뒤로가기 경로 (선택) |

**스타일**: sticky, top: 0, zIndex: 10, 하단 border

### BottomCTA

**파일**: `frontend/src/components/BottomCTA.tsx`

```
┌─────────────────────────────────────┐
│  ┌─────────────────────────────┐    │
│  │         [label]              │    │
│  └─────────────────────────────┘    │
└─────────────────────────────────────┘
```

| Props | 타입 | 설명 |
|-------|------|------|
| label | string | 버튼 텍스트 |
| onClick | () => void | 클릭 핸들러 |
| disabled | boolean | 비활성화 여부 |

**스타일**: fixed bottom, backdrop-filter blur

### ReceiptCard

**파일**: `frontend/src/components/ReceiptCard.tsx`

정산 계약서 스타일 카드

| 필드 | 값 |
|------|-----|
| 품목 | 챌린지 제목 |
| 기간 | N일 (작심삼일) |
| 참가비 | 금액 |
| 성공 시 | 환급(리워드) |
| 실패 시 | 리워드 미지급 |

### LegalFooter

**파일**: `frontend/src/components/LegalFooter.tsx`

모든 페이지 하단 법적 링크:
- 이용약관 → `/terms`
- 개인정보처리방침 → `/privacy`
- 고객센터 → `/support`
- 이용안내 → `/help`

---

## 화면 흐름도

```
                    ┌──────────┐
                    │  /login  │
                    └────┬─────┘
                         │ appLogin() → 토큰 교환
                         ▼
┌──────────┐      ┌──────────┐      ┌─────────────────┐
│  /help   │ ←──→ │    /     │ ───→ │ /challenge/:id  │
│  /terms  │      │ (홈/목록) │      │  (챌린지 상세)   │
│  /privacy│      └────┬─────┘      └────────┬────────┘
│  /support│           │                     │ 결제
└──────────┘           │                     ▼
                       │            ┌─────────────────┐
                       │            │   /proof/:id    │
                       │            │   (인증 제출)    │
                       │            └────────┬────────┘
                       │                     │ 인증 완료
                       ▼                     ▼
                  ┌──────────┐ ◄─────────────┘
                  │ /history │
                  │ (정산내역)│
                  └──────────┘
```

---

## API 엔드포인트

### 인증

| 메서드 | 경로 | 설명 | mTLS |
|--------|------|------|------|
| POST | /v1/auth/toss/exchange | 토스 인가코드 → 토큰 | 필수 |
| POST | /v1/auth/exchange | 스텁 로그인 (개발용) | - |
| POST | /v1/auth/toss/unlink-callback | 토스 연결 해제 콜백 | 필수 |

### 챌린지

| 메서드 | 경로 | 설명 |
|--------|------|------|
| GET | /v1/challenges | 챌린지 목록 조회 |

### 결제

| 메서드 | 경로 | 설명 |
|--------|------|------|
| POST | /v1/payments/create | 결제 생성 (idempotency key) |
| POST | /v1/payments/execute | 결제 실행 |

### 인증 제출

| 메서드 | 경로 | 설명 |
|--------|------|------|
| POST | /v1/proofs/submit | 인증 제출 (idempotency key) |

### 정산

| 메서드 | 경로 | 설명 |
|--------|------|------|
| GET | /v1/settlements/:id | 정산 상태 조회 |

---

## 환경 변수

### 프론트엔드 (Vite)

| 변수 | 설명 | 기본값 |
|------|------|--------|
| VITE_API_BASE_URL | 백엔드 API URL | "" |
| VITE_APP_DISPLAY_NAME | 앱 표시명 | 습관환급 |
| VITE_SUPPORT_EMAIL | 고객센터 이메일 | support@habitrefund.example |
| VITE_SUPPORT_HOURS | 운영시간 | 평일 10:00~18:00 (KST) |
| VITE_COMPANY_NAME | 운영사명 | 운영사 |
| VITE_PRIVACY_EFFECTIVE_DATE | 개인정보처리방침 시행일 | 2025-12-21 |

### 앱인토스 빌드

| 변수 | 설명 |
|------|------|
| AIT_APP_NAME | 콘솔 App ID와 동일 |
| AIT_ICON_URL | 앱 아이콘 URL (선택) |

---

## 심사 제출 체크리스트

```bash
# 1. iframe 사용 확인 (유튜브 외 금지)
bash scripts/10_check_iframe.sh

# 2. 프론트엔드 빌드
bash scripts/20_build_frontend.sh

# 3. 백엔드 빌드
bash scripts/30_build_backend.sh

# 4. .ait 패키지 생성
cd frontend && npx ait build

# 5. 콘솔 업로드 → QR 테스트 (최소 1회)

# 6. 검토 요청 제출
```
